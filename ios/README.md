# Sit - iOS Companion App

iOS companion app that syncs data between Convex backend and Apple Watch.

## Project Structure

```
ios/
├── Sit/
│   ├── SitApp.swift              # App entry point
│   ├── ContentView.swift         # Main UI
│   ├── SyncViewModel.swift       # State management & sync logic
│   ├── ConvexService.swift       # Convex HTTP API client
│   ├── Models.swift              # Data models
│   └── Info.plist                # App configuration
└── README.md
```

## Features

- ✅ Syncs beliefs from Convex
- ✅ Syncs timer presets from Convex
- ✅ Syncs prompt settings from Convex
- ✅ Logs meditation sessions to Convex
- ✅ Logs prompt responses to Convex
- ✅ Automatic background sync every 30 seconds
- ✅ Pull-to-refresh support

## Setup Instructions

### 1. Create Xcode Project

Since Xcode project files (`.xcodeproj`) are binary and need to be generated by Xcode, you'll need to create the project manually:

1. Open Xcode
2. Create a new project: **File > New > Project**
3. Select **iOS > App**
4. Configure:
   - Product Name: `Sit`
   - Team: (your team)
   - Organization Identifier: `com.yourname`
   - Interface: **SwiftUI**
   - Language: **Swift**
   - Storage: **None**
5. Save to: `ios/` directory (this will create `ios/Sit.xcodeproj`)

### 2. Replace Default Files

After Xcode creates the project:

1. Delete the auto-generated Swift files in the Sit folder
2. Add the existing Swift files from `ios/Sit/`:
   - SitApp.swift
   - ContentView.swift
   - SyncViewModel.swift
   - ConvexService.swift
   - Models.swift
3. Replace the default Info.plist with the one in `ios/Sit/Info.plist`

### 3. Configure Network Permissions

The `Info.plist` already includes `NSAppTransportSecurity` settings to allow HTTP connections to `localhost:3210` for Convex dev server.

### 4. Start Convex Backend

Make sure the Convex dev server is running:

```bash
cd ../web
npx convex dev
```

This should start the server at `http://127.0.0.1:3210`.

### 5. Run the App

1. Select a simulator (iPhone 15 Pro or newer recommended)
2. Click **Run** (⌘R)

The app will:
- Automatically sync data from Convex on launch
- Continue syncing every 30 seconds
- Allow manual sync via "Sync Now" button or pull-to-refresh

## Testing

### Verify Sync from Convex

1. Open the web dashboard at http://localhost:5173
2. Add some beliefs, timer presets, and configure prompt settings
3. Open the iOS app
4. Verify the data appears in the respective sections

### Test Logging to Convex

1. In the iOS app, tap "Log Test Meditation (5 min)"
2. Go to web dashboard and check if a new meditation session appears
3. Tap "Log Test Response (Yes)" or "Log Test Response (No)"
4. Verify prompt responses appear in web dashboard stats

## Architecture

### Data Flow

```
Convex ←→ iOS App ←→ Watch App
         (HTTP)    (WatchConnectivity)
```

### Sync Strategy

- **Pull**: iOS polls Convex every 30 seconds for beliefs, presets, and settings
- **Push**: iOS immediately sends meditation sessions and prompt responses to Convex
- **Future**: Will relay data to/from Watch via WatchConnectivity (f8)

### Models

All models match the Convex schema:

- `Belief`: Limiting beliefs text with timestamps
- `TimerPreset`: Duration presets for meditation timer
- `PromptSettings`: Configuration for random prompts (frequency, waking hours)
- `MeditationSession`: Completed meditation sessions
- `PromptResponse`: "In the View?" responses

### Convex API

The `ConvexService` class provides async methods:

**Queries (GET data):**
- `listBeliefs()` → `[Belief]`
- `listTimerPresets()` → `[TimerPreset]`
- `getPromptSettings()` → `PromptSettings?`
- `listMeditationSessions(limit:)` → `[MeditationSession]`

**Mutations (POST data):**
- `createBelief(text:)` → `String` (ID)
- `logMeditationSession(...)` → `String` (ID)
- `logPromptResponse(...)` → `String` (ID)

## Next Steps (Future Features)

- [ ] **f8-ios-watch-connectivity**: Bridge to Watch via WatchConnectivity framework
- [ ] **f9-ios-notifications**: Schedule random prompt notifications
- [ ] Persistent local cache with CoreData/SwiftData
- [ ] Handle offline mode gracefully
- [ ] Production Convex deployment URL configuration

## Troubleshooting

### "Failed to connect to Convex"

- Ensure Convex dev server is running: `cd web && npx convex dev`
- Check server is accessible at http://127.0.0.1:3210
- Verify simulator can reach localhost (should work by default)

### "No data appearing"

- Check web dashboard has data created
- Tap "Sync Now" to force immediate sync
- Check Xcode console for error messages

### Network debugging

Check Xcode console for sync logs:
- `✅ Sync complete: X beliefs, Y presets` = success
- `❌ Sync error: ...` = failure with details
